(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{236:function(e,t,a){"use strict";a.r(t);var s=a(6),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"runtime"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runtime"}},[e._v("#")]),e._v(" Runtime")]),e._v(" "),a("p",[e._v("The AssemblyScript runtime implements the necessary bits for memory management and garbage collection. It is largely invisible to a developer but can become relevant in advanced use cases, for example when integrating AssemblyScript in new environments.")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),a("p",[e._v("If not applicable to your use case, i.e. it is not necessary to interact with the runtime directly, you can safely skip this section.")])]),e._v(" "),a("h2",{attrs:{id:"variants"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#variants"}},[e._v("#")]),e._v(" Variants")]),e._v(" "),a("p",[e._v("The runtime comes in different flavors, each useful in different use cases. The desired runtime can be specified with the "),a("code",[e._v("--runtime")]),e._v(" compiler option:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("  --runtime             Specifies the runtime variant to include in the program.\n\n                         incremental  TLSF + incremental GC (default)\n                         minimal      TLSF + lightweight GC invoked externally\n                         stub         Minimal runtime stub (never frees)\n                         ...          Path to a custom runtime implementation\n\n  --exportRuntime       Exports the runtime helpers (__new, __collect etc.).\n")])])]),a("p",[e._v("The default "),a("code",[e._v("incremental")]),e._v(" runtime provides the full package recommended in most use cases. The "),a("code",[e._v("minimal")]),e._v(" runtime is a stripped down variant (no shadow stack, no heuristic, simpler algorithm, smaller and more efficient) that is not automated and requires calling "),a("code",[e._v("__collect")]),e._v(" externally at appropriate times (when there are no more values on the WebAssembly stack, which would be the case when WebAssembly calls out to the host, directly or indirectly), whereas the "),a("code",[e._v("stub")]),e._v(" runtime does not provide a garbage collector at all and never frees (simple bump allocation, extremely small).")]),e._v(" "),a("p",[e._v("For example, the "),a("code",[e._v("stub")]),e._v(" runtime can be useful where modules are short-lived and collected as a whole anyhow, while the "),a("code",[e._v("minimal")]),e._v(" runtime provides a compromise for use cases where it is sufficient to collect garbage manually, occasionally, say where a module performs a fixed amount of work before being invoked again.")]),e._v(" "),a("p",[e._v("In case of doubt, use "),a("code",[e._v("incremental")]),e._v(", but feel free to experiment with the other potentially more efficient variants where a use case permits.")]),e._v(" "),a("h2",{attrs:{id:"interface"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#interface"}},[e._v("#")]),e._v(" Interface")]),e._v(" "),a("p",[e._v("Using the "),a("code",[e._v("--exportRuntime")]),e._v(" compiler option, the runtime interface can be exported from the module to the host, so it becomes possible to allocate new managed objects and invoke the garbage collector externally.")]),e._v(" "),a("p",[e._v("It is typically not necessary to invoke the runtime interface manually since generated bindings take care of all the internals. In environments where bindings are not yet available, however, the runtime interface can be utilized to provide the necessary integration.")]),e._v(" "),a("ul",[a("li",[a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("__new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("size"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("u32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),e._v("\n")])])]),a("p",[e._v("Allocates a new garbage collected instance of the object represented by the specified class id, of at least the specified size. Returns the pointer to the object (pointing at its data, not its internal header).")])]),e._v(" "),a("li",[a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("__pin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("ptr"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),e._v("\n")])])]),a("p",[e._v("Pins the object pointed to by "),a("code",[e._v("ptr")]),e._v(" externally so it and any object it references do not become garbage collected. Note that the same object cannot be pinned more than once.")]),e._v(" "),a("p",[e._v("An external object that is not referenced from within WebAssembly must be pinned whenever an allocation might happen in between allocating it and passing it to WebAssembly. If not pinned, the allocation may trigger the garbage collector to step, which would prematurely collect the object and lead to undefined behavior.")])]),e._v(" "),a("li",[a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("__unpin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("ptr"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v("\n")])])]),a("p",[e._v("Unpins the object pointed to by "),a("code",[e._v("ptr")]),e._v(" externally so it can become garbage collected. Note that the respective object must have been pinned before for the unpin operation to succeed.")])]),e._v(" "),a("li",[a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("__collect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v("\n")])])]),a("p",[e._v("Performs a full garbage collection.")])]),e._v(" "),a("li",[a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" __rtti_base"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[e._v("usize")]),e._v("\n")])])]),a("p",[e._v("Pointer to runtime type information in linear memory. RTTI contains information about the various classes utilized in a binary, mapping class ids to object kinds, their key and value layout, and base classes. Its layout is described in detail in "),a("a",{attrs:{href:"https://github.com/AssemblyScript/assemblyscript/blob/main/std/assembly/shared/typeinfo.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("shared/typeinfo"),a("OutboundLink")],1),e._v(". Using RTTI, it becomes possible to implement "),a("code",[e._v("instanceof")]),e._v(" for example, or to tell strings, arrays etc. apart.")])])]),e._v(" "),a("h2",{attrs:{id:"memory-layout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#memory-layout"}},[e._v("#")]),e._v(" Memory layout")]),e._v(" "),a("p",[e._v("Overall, AssemblyScript partitions linear memory as follows:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Region")]),e._v(" "),a("th",[e._v("Start offset")]),e._v(" "),a("th",[e._v("End offset")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("Static data")]),e._v(" "),a("td",[a("code",[e._v("0")])]),e._v(" "),a("td",[a("code",[e._v("__data_end")])]),e._v(" "),a("td",[e._v("Contents of static strings, arrays, etc.")])]),e._v(" "),a("tr",[a("td",[e._v("Managed stack")]),e._v(" "),a("td",[a("code",[e._v("__data_end")])]),e._v(" "),a("td",[a("code",[e._v("__heap_base")])]),e._v(" "),a("td",[e._v("Present only if the incremental runtime is used.")])]),e._v(" "),a("tr",[a("td",[e._v("Heap")]),e._v(" "),a("td",[a("code",[e._v("__heap_base")])]),e._v(" "),a("td",[a("code",[e._v("memory.size() << 16")])]),e._v(" "),a("td",[e._v("Remaining space is used for dynamic allocations. Can grow.")])])])]),e._v(" "),a("h3",{attrs:{id:"header-layout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#header-layout"}},[e._v("#")]),e._v(" Header layout")]),e._v(" "),a("p",[e._v("Any kind of managed object in AssemblyScript utilizes a managed header for the runtime to operate on:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[e._v("Name")]),e._v(" "),a("th",{staticStyle:{"text-align":"right"}},[e._v("Offset")]),e._v(" "),a("th",{staticStyle:{"text-align":"left"}},[e._v("Type")]),e._v(" "),a("th",{staticStyle:{"text-align":"left"}},[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("mmInfo")]),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("-20")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("usize")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Memory manager info")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("gcInfo")]),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("-16")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("usize")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Garbage collector info")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("gcInfo2")]),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("-12")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("usize")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Garbage collector info")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("rtId")]),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("-8")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("u32")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Unique id of the concrete class")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[e._v("rtSize")]),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("-4")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("u32")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Size of the data following the header")])]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}}),e._v(" "),a("td",{staticStyle:{"text-align":"right"}}),e._v(" "),a("td",{staticStyle:{"text-align":"left"}}),e._v(" "),a("td",{staticStyle:{"text-align":"left"}})]),e._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}}),e._v(" "),a("td",{staticStyle:{"text-align":"right"}},[e._v("0")]),e._v(" "),a("td",{staticStyle:{"text-align":"left"}}),e._v(" "),a("td",{staticStyle:{"text-align":"left"}},[e._v("Payload starts here")])])])]),e._v(" "),a("p",[e._v("References to an object always point at the start of the payload, with the header beginning 20 bytes before. Null references are just the value "),a("code",[e._v("0")]),e._v(". When working with an AssemblyScript module externally, knowing the memory layout can be helpful to for example obtain an object's class id or size. Invoking "),a("code",[e._v("__new")]),e._v(" automatically prepends a managed header and registers the object with the GC, using the provided class id for "),a("code",[e._v("rtId")]),e._v(" and the provided size for "),a("code",[e._v("rtSize")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"class-layout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#class-layout"}},[e._v("#")]),e._v(" Class layout")]),e._v(" "),a("p",[e._v("Class fields are laid out similarly to C structs, sequentially and without packing. Each field is aligned to its type's native alignment, potentially leaving padding in between. If a class has the "),a("code",[e._v("@unmanaged")]),e._v(" decorator, it effectively only describes a region of memory as if it were a struct that does not utilize a managed header, is not garbage collected, and can be used with "),a("code",[e._v("heap.free")]),e._v(". Managed classes with a managed header cannot be manually freed, and managed and unmanaged classes cannot be mixed (e.g. extend from each other).")]),e._v(" "),a("p",[e._v("Standard library data types use the following layouts:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Class")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("Object")]),e._v(" "),a("td",[e._v("Object, the base class of all managed classes, has a class id of "),a("code",[e._v("0")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[e._v("ArrayBuffer")]),e._v(" "),a("td",[e._v("Buffers always use class id "),a("code",[e._v("1")]),e._v(", with their untyped data as the payload.")])]),e._v(" "),a("tr",[a("td",[e._v("String")]),e._v(" "),a("td",[e._v("Strings always use class id "),a("code",[e._v("2")]),e._v(", with their 16-bit char codes (UTF-16 code units, allowing isolated surrogates like JS) as the payload. For example, if "),a("code",[e._v("rtSize")]),e._v(" is "),a("code",[e._v("8")]),e._v(", the string's "),a("code",[e._v(".length")]),e._v(" is "),a("code",[e._v("4")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[e._v("TypedArray")]),e._v(" "),a("td",[e._v("Typed arrays are objects composed of "),a("code",[e._v("buffer")]),e._v(" (the reference to the viewed "),a("code",[e._v("ArrayBuffer")]),e._v("), "),a("code",[e._v("dataStart")]),e._v(" (the start pointer into "),a("code",[e._v("buffer")]),e._v(") and "),a("code",[e._v("byteLength")]),e._v(" fields, in this order. The respective id is picked sequentially and not predetermined.")])]),e._v(" "),a("tr",[a("td",[e._v("Array<T>")]),e._v(" "),a("td",[e._v("Normal arrays use the same layout as typed arrays, with an additional mutable "),a("code",[e._v("length")]),e._v(" field coming last.")])]),e._v(" "),a("tr",[a("td",[e._v("StaticArray<T>")]),e._v(" "),a("td",[e._v("Static arrays do not need indirection due to not being resizable, and they have their data right in the payload, aligned according to "),a("code",[e._v("T")]),e._v(". Can be thought of as a typed buffer.")])]),e._v(" "),a("tr",[a("td",[e._v("Function")]),e._v(" "),a("td",[e._v("Functions are objects composed of their table "),a("code",[e._v("index")]),e._v(" and their lexical "),a("code",[e._v("env")]),e._v(" (currently always "),a("code",[e._v("0")]),e._v(").")])]),e._v(" "),a("tr",[a("td",[e._v("Map/Set/...")]),e._v(" "),a("td",[e._v("Other collection use more complex layouts. Please refer to their respective sources.")])])])]),e._v(" "),a("p",[e._v("It is also possible to build custom data types that integrate with the GC by implementing the "),a("code",[e._v("__visit")]),e._v(" interface (that iterates all references contained in an object of this kind). Please refer to the sources of preexisting data types for examples.")]),e._v(" "),a("h2",{attrs:{id:"calling-convention"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#calling-convention"}},[e._v("#")]),e._v(" Calling convention")]),e._v(" "),a("p",[e._v("AssemblyScript's calling convention is relatively straight forward, as it does not add additional parameters to functions or other behind-the-scenes magic. Note that generated bindings take care of the calling convention automatically, but other environments may want to adhere to it specifically.")]),e._v(" "),a("h3",{attrs:{id:"basic-values"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-values"}},[e._v("#")]),e._v(" Basic values")]),e._v(" "),a("p",[e._v("Exported functions wrap basic numeric return values to their respective value ranges. Basic numeric values passed to exported functions are wrapped to their respective value ranges on demand.")]),e._v(" "),a("h3",{attrs:{id:"managed-values"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#managed-values"}},[e._v("#")]),e._v(" Managed values")]),e._v(" "),a("p",[e._v("Any kind of object is passed as a pointer into memory, and the host is expected to perform the steps necessary to exchange the value between linear memory and the host system. For example, when a string is passed from WebAssembly to the host or vice-versa, it is not its data that is passed but a pointer to the string's data in linear memory. In order to read the data, the managed header before the payload can be evaluated to obtain the string's byte length. Note that "),a("RouterLink",{attrs:{to:"/compiler.html#host-bindings"}},[e._v("host bindings")]),e._v(" automate this process for common data types.")],1),e._v(" "),a("h3",{attrs:{id:"optional-arguments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optional-arguments"}},[e._v("#")]),e._v(" Optional arguments")]),e._v(" "),a("p",[e._v("When an exported function allows one or multiple arguments to be omitted, the module must be informed of the number of significant arguments by calling "),a("code",[e._v("exports.__setArgumentsLength(numArgs)")]),e._v(" before calling the export, so it can fill in default values. Omitted arguments are not evaluated, i.e. zeroes can be passed. Not calling the helper leads to undefined behavior. If a function has a fixed number of arguments, it is not necessary to call the helper. The helper may not be present if a module only exports functions with a fixed number of arguments.")])])}),[],!1,null,null,null);t.default=n.exports}}]);